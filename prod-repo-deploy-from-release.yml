name: Deploy Pages from released artifact (sample)

on:
  repository_dispatch:
    types: [deploy-prod-artifact]
  workflow_dispatch:
    inputs:
      asset_url:
        description: "Direct download URL to the released site archive (.tar.gz)"
        required: false
        type: string
      sha256:
        description: "SHA256 for the archive"
        required: false
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Resolve inputs
        id: inp
        run: |
          set -e
          URL="${{ github.event.client_payload.asset_url }}"
          if [ -z "$URL" ]; then URL="${{ github.event.inputs.asset_url }}"; fi
          SHA="${{ github.event.client_payload.sha256 }}"
          if [ -z "$SHA" ]; then SHA="${{ github.event.inputs.sha256 }}"; fi
          if [ -z "$URL" ] || [ -z "$SHA" ]; then
            echo "asset_url and sha256 are required (via repository_dispatch payload or workflow_dispatch inputs)" >&2
            exit 1
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Download released archive
        run: |
          curl -L "${{ steps.inp.outputs.url }}" -o site.tar.gz

      - name: Verify checksum
        run: |
          echo "${{ steps.inp.outputs.sha }}  site.tar.gz" | sha256sum -c -

      - name: Extract to public/
        run: |
          mkdir -p public
          tar -C public -xzf site.tar.gz

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
